
@{
    ViewBag.Title = "UserManagement";
}

<h1>@Kaisokku_Sales.Resources.Resource.UserManagement</h1>
@Html.Hidden("DeleteUserId")
@*<div class="row" style="padding-top: 10px;">
        <div class="col-md-2">
            @Html.Label(@Kaisokku_Sales.Resources.Resource.Username)
            @Html.Hidden("UserId")
        </div>
        <div class="col-md-3">
            @Html.TextBox("UserName", null, new { @class = "form-control", id = "UserName" })
        </div>
    </div>
    <div class="row" style="padding-top: 10px;">
        <div class="col-md-2">
            @Html.Label(@Kaisokku_Sales.Resources.Resource.Password)
        </div>
        <div class="col-md-3">
            @Html.TextBox("Password", null, new { @class = "form-control", id = "Password" })
        </div>
    </div>
    <div class="row" style="padding-top: 10px;">
        <div class="col-md-2">
            @Html.Label(@Kaisokku_Sales.Resources.Resource.Email)
        </div>
        <div class="col-md-3">
            @Html.TextBox("Email", null, new { @class = "form-control", id = "Email" })
        </div>
    </div>

    <div class="row">
        <div class="col-md-2">
            @Html.Label(@Kaisokku_Sales.Resources.Resource.CustomerType)
        </div>
        <div class="col-md-4">
            @Html.DropDownList("CustomerSelection", (IEnumerable
           <SelectListItem>)TempData["CustomerSelection"])
        </div>

        @{TempData.Keep("CustomerSelection");}
    </div>



    <div class="row checkbox">
        <div class="col-md-2">
            @Html.Label(@Kaisokku_Sales.Resources.Resource.Active)
        </div>
        <div class="col-md-1">
            @Html.CheckBox("IsActive", false, new { })
        </div>
        <div class="col-md-3" style="padding-bottom: 5px;">
            <button class="btn btn-primary" type="submit" id="btnSubmit">@Kaisokku_Sales.Resources.Resource.Submit</button>
        </div>
    </div>
    <div class="row checkbox">
        <div class="col-md-2">
            @Html.Label(@Kaisokku_Sales.Resources.Resource.Client)
        </div>
        <div class="col-md-1">
            @Html.CheckBox("IsClient", false, new { })
        </div>
    </div>*@
<label id="UID" style="display:none" value=" @ViewBag.userid">@ViewBag.userid</label>
<div>
    <button type="submit" onclick="CreateUser()" class="btn btn-primary btncreate">Create New</button>

</div>
<div>
    <br />
    <div style="background:white;padding:10px;">
        <br />
        <table id="UserGrid" class="table table-striped table-bordered dt-responsive nowrap" width="100%" cellspacing="0">
            <thead>
                <tr>
                    <th>UserMasterId</th>
                    <th>@Kaisokku_Sales.Resources.Resource.Username</th>
                    <th>@Kaisokku_Sales.Resources.Resource.Password</th>
                    <th>@Kaisokku_Sales.Resources.Resource.IsActive</th>
                    @*<th>CreatedDate</th>*@
                    <th>@Kaisokku_Sales.Resources.Resource.CustomerTypeName</th>

                    <th>@Kaisokku_Sales.Resources.Resource.Email</th>
                    @*<th>@Kaisokku_Sales.Resources.Resource.ClientUser</th>*@
                    <th>@Kaisokku_Sales.Resources.Resource.Edit</th>
                    <th>@Kaisokku_Sales.Resources.Resource.Delete</th>
                </tr>
            </thead>
        </table>
    </div>
</div>


<div class="modal fade" id="DeleteUserModal" tabindex="-1" role="dialog" aria-labelledby="DeleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="DeleteUserModalLabel">@Kaisokku_Sales.Resources.Resource.DeleteUser</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body Deleteusercontent">
                @Kaisokku_Sales.Resources.Resource.Areyousuretodeleteuser

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">@Kaisokku_Sales.Resources.Resource.No</button>
                <button type="button" class="btn btn-primary btndeleteuser btn-danger">@Kaisokku_Sales.Resources.Resource.Yes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="EditUserModal" tabindex="-1" role="dialog" aria-labelledby="EditUserModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="EditUserModalLabel">@Kaisokku_Sales.Resources.Resource.EditUser</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body editusercontent">
                EditUserModal

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">@Kaisokku_Sales.Resources.Resource.Close</button>
                <button type="button" class="btn btn-primary btnsaveuser">@Kaisokku_Sales.Resources.Resource.SaveChanges</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="CreateModal" tabindex="-1" role="dialog" aria-labelledby="CreateModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="CreateModalLabel">Create User</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body Createusercontent">
                CreateUser

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">@Kaisokku_Sales.Resources.Resource.Close</button>
                <button type="button" id="btnSubmit" class="btn btn-primary btnscreate">@Kaisokku_Sales.Resources.Resource.SaveChanges</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="SucMSG" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">

            <div class="modal-body ">
                <label id="MSG"></label>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>
@section ScriptSection{

    <script>
    $(document).ready(function () {
        //debugger;
        $.ajax({
            url: '@Url.Action("GetLastUserId", "Home")',
            type: 'GET',
            success: function (result) {
                $('#UserId').val(result);
            },
            error: function (error) {
                console.log(error);
            }
        });

    });
    </script>

    <script>
        function RefreshDataTable() {
            $('#UserGrid').DataTable().ajax.reload(null, false);
            $("#UserGrid").DataTable().page('first').draw('page');
        }
    </script>

    <script>
        $(document).ready(function () {
            $("#UserGrid").DataTable({
                "processing": true, // for show progress bar
                "serverSide": false, // for process server side
                "filter": true, // this is for disable filter (search box)
                "orderMulti": false, // for disable multiple column at once
                "pageLength": 10,
                "searchPlaceholder": true,
                language: {
                    searchPlaceholder: "User Name/Email"
                },
                "ajax": {
                    "url":  "@Url.Action("LoadUserListData", "Home")",
                    "type": "POST",
                    "datatype": "json"
                },

                "columnDefs":
                    [{
                        "targets": [0],
                        "visible": false,
                        "searchable": false,
                        "orderable": false
                    },

                    {
                        "targets": [1],
                        "searchable": true,
                        "orderable": true
                    },

                    {
                        "targets": [2],
                        "searchable": false,
                        "orderable": true
                    },

                    {
                        "targets": [3],
                        "searchable": false,
                        "orderable": true
                    },

                    {
                        "targets": [4],
                        "searchable": false,
                        "orderable": false
                    },



                    {
                        "targets": [5],
                        "searchable": true,
                        "orderable": true
                    },
                        {
                            "targets": [6],

                            "searchable": false,
                            "orderable": true
                        },

                    {
                        "targets": [7],
                        "searchable": false,
                        "orderable": false
                        }

                    //,
                    //{
                    //    "targets": [8],
                    //    "searchable": false,
                    //    "orderable": false
                    //}
                    ],


                "columns": [
                    { "data": "UserMasterId", "name": "UserMasterId", "autoWidth": true },
                    { "data": "UserName", "name": "UserName", "autoWidth": true },
                    { "data": "Password", "name": "Password", "autoWidth": true },


                    { "data": "IsActive", "name": "IsActive", "autoWidth": true },
                    //{
                    //    "data": "CreatedDate", "name": "CreatedDate", "autoWidth": true,
                    //    "type": "date ",
                    //    "render": function (value) {
                    //        if (value === null) return "";
                    //        var pattern = /Date\(([^)]+)\)/;
                    //        var results = pattern.exec(value);
                    //        var dt = new Date(parseFloat(results[1]));
                    //        var month = dt.getMonth() + 1;
                    //        //return (month.toString().length > 1 ? month : "0" + month) + "/" + dt.getDate() + "/" + dt.getFullYear()
                    //        return (dt.getFullYear() + "/" + (month.toString().length > 1 ? month : "0" + month) + "/" + dt.getDate())

                    //    }
                    //},
                    //{ "data": "CreatedDate", "name": "CreatedDate", "autoWidth": true },
                    { "data": "CustomerTypeName", "name": "CustomerTypeName", "autoWidth": true },
                    { "data": "Email", "name": "Email", "autoWidth": true },
                  /*  { "data": "Client", "name": "Client", "autoWidth": true },*/
                    {
                        //"render": function (data, type, row, meta) { return "<a class='btn btn-info' href='javascript:void(0);' onclick=EditUser('" + row.UserMasterId + "');>@Kaisokku_Sales.Resources.Resource.Edit</a>"; }
                        "render": function (data, type, row, meta) { return "<a class='' href='javascript:void(0);' onclick=EditUser('" + row.UserMasterId + "');><span  class='glyphicon glyphicon-pencil' aria-hidden='true'></a>"; }
                    },
                    {
                        data: null, render: function (data, type, row) {
                           // return "<a href='#' class='btn btn-danger' onclick=DeleteUserConfirmation('" + row.UserMasterId + "'); >@Kaisokku_Sales.Resources.Resource.Delete</a>";
                            return "<a href='#' class='' onclick=DeleteUserConfirmation('" + row.UserMasterId + "'); ><span  class='glyphicon glyphicon-trash' aria-hidden='true'></span></a>";
                        }
                    },

                ]

            });


        });
    </script>


    <script>
        $('.btnsaveuser').on('click', function () {

            var expr = /^([\w-\.]+)@@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;

            var UserMasterId = $('#EditUserId').val();
            var UserName = $('#EditUserName').val();
            var Password = $('#EditPassword').val();

            var IsActive = $("#Active").is(':checked')
            var IsClient = $("#Client").is(':checked')

            var Email = $('#EditEmail').val();
            if (UserName == "" && Password == "" && Email == "") {
                $('#Uname').text("Please Enter the User Name");
                $('#Pwd').text("Please Enter the Password");
                $('#Mail').text("Please Enter the Mail");
            }
            else if (UserName == "" && Password == "") {
                $('#Uname').text("Please Enter the User Name");
                $('#PWD').text("Please Enter the Password");
                if (!expr.test(Email)) {
                    $('#Mail').text("Enter Valid Email");
                }
                else {
                    $('#Mail').text("");
                }
            }
            else if (UserName == "" && Email == "") {
                $('#Uname').text("Please Enter the User Name");
                $('#PWD').text("");
                $('#Email').text("Please Enter the Mail");
            }
            else if (Password == "" && Email == "") {
                $('#Uname').text("Please Enter the User Name");
                $('#PWD').text("Please Enter the Password");
                $('#Email').text("Please Enter the Mail");
            }
            else if (UserName == "") {
                $('#Uname').text("Please Enter the User Name");
                $('#PWD').text(""); i
                if(!expr.test(Email)) {
                    $('#Mail').text("Enter Valid Email");
                }
                else {
                    $('#Mail').text("");
                }
            }
            else if (Password == "") {
                $('#Uname').text("");
                $('#PWD').text("Please Enter the Password");
                if (!expr.test(Email)) {
                    $('#Mail').text("Enter Valid Email");
                }
                else {
                    $('#Mail').text("");
                }
            }
            else if (Email == "") {
                $('#Uname').text("");
                $('#PWD').text("");
                $('#Mail').text("Please Enter the Mail");
            }
            else if (!expr.test(Email)) {
                $('#Uname').text("");
                $('#PWD').text("");
                $('#Mail').text("Enter Valid Email");
            }

            else {
                $('#Uname').text("");
                $('#PWD').text("");
                $('#Mail').text("");

                var CustomerType = $('#CustomerType option:selected').val();
            $('#EditUserModal').modal('hide');
                $.ajax({
                    url: '@Url.Action("SaveUserListData", "Home")',
                    type: 'POST',
                    data: { 'UserMasterId': UserMasterId, 'UserName': UserName, 'Password': Password, 'Active': IsActive, 'Email': Email, 'CustomerType': CustomerType, 'Client': IsClient},
                    success: function (result) {

                        if (result.errorcode == 0) {
                          
                            @*alert('@Kaisokku_Sales.Resources.Resource.UserUpdatedSuccessfully');*@
                            RefreshDataTable();
                            $('#MSG').text("User Updated Successfully")
                            $("#SucMSG").modal('show');
                        }
                        else {
                            $('#MSG').text("User Updated Failed")
                            $("#SucMSG").modal('show');
                            @*alert('@Kaisokku_Sales.Resources.Resource.UserUpdationFailed');*@
                        }
                    },
                    error: function (error) {
                        console.log(error);
                    }

                });
            }


        });







    $('#btnSubmit').on('click', function () {
        var expr = /^([\w-\.]+)@@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;


        var UserName = $('#UserName').val();
        var Password = $('#Password').val();
        var Email = $('#Email').val();
        if (UserName == "" && Password == "" && Email == "") {
            $('#Uname').text("Please Enter the User Name");
            $('#PWD').text("Please Enter the Password");
            $('#Mail').text("Please Enter the Mail");
        }
        else if (UserName == "" && Password == "") {
            $('#Uname').text("Please Enter the User Name");
            $('#PWD').text("Please Enter the Password");
            if (!expr.test(Email)) {
                $('#Mail').text("Enter Valid Email");
            }
            else {
                $('#Mail').text("");
            }
        }
        else if (UserName == "" && Email == "") {
            $('#Uname').text("Please Enter the User Name");
            $('#PWD').text("");
            $('#Mail').text("Please Enter the Mail");
        }
        else if (UserName == "") {
            $('#Uname').text("Please Enter the User Name");
            $('#PWD').text("");
            if (!expr.test(Email)) {
                $('#Mail').text("Enter Valid Email");
            }
            else {
                $('#Mail').text("");
            }
        }
        else if (Password == "" && Email == "") {
            $('#Uname').text("");
            $('#PWD').text("Please Enter the Password");
            $('#Mail').text("Please Enter the Mail");
        }
        else if (Password == "") {
            $('#Uname').text("");
            $('#PWD').text("Please Enter the Password");
            if (!expr.test(Email)) {
                $('#Mail').text("Enter Valid Email");
            }
            else {
                $('#Mail').text("");
            }
        }
        else if (Email == "") {
            $('#Uname').text("");
            $('#PWD').text("");
            $('#Mail').text("Please Enter the Mail");
        }
        else if (!expr.test(Email)) {
            $('#Mail').text("Enter Valid Email");
            $('#Uname').text("");
            $('#PWD').text("");
        }
        else {
            $('#Mail').text("");
            $('#Uname').text("");
            $('#PWD').text("");
            var Active = $("#IsActive").is(':checked')
        var Client = $("#IsClient").is(':checked')
        var UserId = $('#UserId').val();
        var CustomerType = $('#CustomerSelection option:selected').val();
        var dataobj = {
            'UserName': UserName, 'Password': Password, 'UserId': UserId, 'IsActive': Active, 'Email': Email, 'CustomerType': CustomerType, 'IsClient': Client};
        $.ajax({
        url: '@Url.Action("AddUserInformation", "Home")',
        type: 'POST',
        data: dataobj,
        success: function (result) {

        if (result.errorcode == 0)
        {

            $('#UserName').val("");
            $('#Password').val("");
            //$('#Email').val("");
            $("#IsActive").prop("checked", false);
            //$('#UserId').val();
            $('#Email').val("");
            $("#IsClient").prop("checked", false);
            RefreshDataTable();
            @*alert('@Kaisokku_Sales.Resources.Resource.UserSavedSuccessfully');*@
            $('#CreateModal').modal('hide');
            $('#MSG').text("User Created Successfully")
            $("#SucMSG").modal('show');
        }
        else
        {
            $('#MSG').text("User Created Failed")
            $("#SucMSG").modal('show');
            //alert('@Kaisokku_Sales.Resources.Resource.UserSaveFailed');
        }
        },
        error: function (error) {
                console.log(error);
        }

        });
        }


    });
    </script>



    <script>


        function DeleteUserConfirmation(UserMasterId) {

            var UID = $('#UID').text();
            var userid = UserMasterId;

            if (UID == userid) {
                //alert("Unable to delete user")
                $('#MSG').text("Unable to delete user")
                $("#SucMSG").modal('show');
            }
            else {
                $('#DeleteUserId').val(UserMasterId);
                $('#DeleteUserModal').modal('show');
            }

        }


        $('.btndeleteuser').on('click', function () {
            DeleteUser($('#DeleteUserId').val());
        });



    </script>

    <script>
        function DeleteUser(UserMasterId) {

            $('#DeleteUserModal').modal('hide');
            $.ajax({
                url: '@Url.Action("DeleteUserById", "Home")',
                type: 'POST',
                data: { 'UserMasterId': UserMasterId },
                success: function (result) {
                    if (result.errorcode == 0) {

                        //alert('@Kaisokku_Sales.Resources.Resource.UserDeletedSuccessfully');
                        RefreshDataTable();
                        $('#MSG').text("User Deleted Successfully")
                        $("#SucMSG").modal('show')
                    }
                    else {
                        $('#MSG').text("User Deleted Failed")
                        $("#SucMSG").modal('show')
                        //alert('@Kaisokku_Sales.Resources.Resource.UserDeletionFailed');
                    }
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }
    </script>

    <script>
        function EditUser(UserMasterId) {
           // debugger;
            $.ajax({
                url: '@Url.Action("GetUserListDataById", "Home")',
                type: 'POST',
                data: { 'UserMasterId': UserMasterId },
                success: function (result) {
                    //CustomerSelectiondebugger;
                    $('.editusercontent').html(result);
                    $('#EditUserModal').modal('show');
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }
        function CreateUser() {

            $.ajax({
                url: '@Url.Action("GetUserListDataById", "Home")',
                type: 'POST',
                data: { 'UserMasterId': 0 },
                success: function (result) {

                    $('.Createusercontent').html(result);
                    $('#CreateModal').modal('show');
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }
    </script>




}
